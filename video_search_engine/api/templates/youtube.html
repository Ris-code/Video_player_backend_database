<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Template</title>
    <link rel="stylesheet" href="{% static 'youtube.css' %}" />
</head>
<body>
    <div id="container">
        <div id="sidePanel">
            <div id="logoContainer">
                <img id="logo" src="https://i.ibb.co/F8y9jvc/images.png" alt="Logo" width="50" height="50">
                <span id="logoText">VIDEO PLAYER</span>
            </div>
            <form id="searchForm" action="{% url 'search_video' %}" method="post">
                {% csrf_token %}
                <div id="searchBar">
                    <input type="text" id="query" name="query" placeholder="Search videos..." required>
                    <button type="button" onclick="searchVideos()" style="font-size: 12px;">&#128269;</button>
                </div>
            </form>

            <ul id="searchResults"></ul>
        </div>
        <div id="mainPanel">
            <!-- <a href="{% url 'store_video' %}" id="profileLink" style="position: absolute; top: 10px; right: 10px; color: #ffffff; text-decoration: none;">
                <img src="https://i.ibb.co/r6Ng54v/770079-people-512x512.png" alt="Profile Picture" style="width: 30px; height: 30px; border-radius: 50%;">
            </a> -->
            <div id="profileDiv">

                <!-- Profile icon (replace 'path-to-your-image' with the actual path to your profile picture) -->
                <!-- <img src="https://i.ibb.co/r6Ng54v/770079-people-512x512.png" alt="Profile Picture" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 5px;"> -->
        
                <!-- Text next to the profile icon -->
                <a href="{% url 'store_video' %}" id="profileLink" style="text-decoration: none; color: inherit; display: flex; align-items: center;">
                    <!-- Text next to the profile icon -->
                    Rishav Aich <!-- Replace with the actual text you want to display -->

                    <img src="https://i.ibb.co/vdk5Q7f/vector-illustration-avatar-dummy-logo-collection-image-icon-stock-isolated-object-set-symbol-web-137.jpg" alt="Profile Picture" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 5px; margin-left: 5px;">
                </a>
            </div>
            <div style="margin-top: 10px;">
                <iframe id="videoPlayer" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <!-- <div id="channelBox">
                <span id="channelName"></span>
            </div> -->
            <div id="videoInfo">
                <div id="channelBox">
                    <span id="channelName"></span>
                </div>
                <div id="videoStats">
                    <button id="likeButton" onclick="likeVideo(currentVideoId, like)">
                        <span id="likeIcon">üëç</span> <span id="likeCount">0</span>
                    </button>
                    <button id="dislikeButton" onclick="dislikeVideo(currentVideoId, dislike)">
                        <span id="dislikeIcon">üëé</span> <span id="dislikeCount">0</span>
                    </button>

                    <button id="favoriteButton" onclick="favoriteVideo(currentVideoId)">
                        <span id="favoriteIcon" style="color: black;">&#10084;</span>
                    </button>                    

                    <span id="viewsCount"  style="margin-left: 10px;">Views: 0</span>
                    
                </div>
            
            <div id="videoDetails">
                <h2 id="videoTitle"></h2>
                <p id="videoDescription"></p>
            </div>

        </div>

        <!-- <div id="suggestion">
            <h3 style="text-align: center;">Suggestions</h3>
        
        </div> -->

        </div>

    </div>
    
    <script>
        let viewsCount = 0;
        let likeCount = 0;
        let dislikeCount = 0;
        let liked = false;
        let disliked = false;

        function searchVideos() {
            const query = document.getElementById('query').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'search_video' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                },
                body: `query=${encodeURIComponent(query)}`,
            })
            .then(response => response.json())
            .then(data => {
                const searchResults = document.getElementById('searchResults');
                searchResults.innerHTML = '';

                data.results.forEach(video => {
                    const li = document.createElement('li');
                    // li.textContent = `${video.videoInfo.snippet.title} - Views: ${video.videoInfo.statistics.viewCount}`;
                    const titleDiv = document.createElement('div');
                    const viewsDiv = document.createElement('div');

                    titleDiv.textContent = video.videoInfo.snippet.title;
                    viewsDiv.textContent = `Views: ${video.videoInfo.statistics.viewCount}`;
                    li.addEventListener('click', () => {
                        playVideo(video.videoInfo.id, video.videoInfo.statistics.viewCount, video.videoInfo.statistics.likeCount, video.videoInfo.statistics.dislikeCount, video.videoInfo.snippet.title, video.videoInfo.snippet.description, video.videoInfo.snippet.channelTitle);
                        document.getElementById('videoInfo').style.display = 'block';
                        document.getElementById('videoDetails').style.display = 'block';
                        // document.getElementById('channelBox').style.display = 'block';
                    });
                    
                    li.appendChild(titleDiv);
                    li.appendChild(viewsDiv);
                    searchResults.appendChild(li);
                });
            })
            .catch(error => console.error('Error:', error));
        }

        function playVideo(videoId, viewsCount, likeCount, dislikeCount, title, description, channelName) {
            console.log(videoId);
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.src = `https://www.youtube.com/embed/${videoId}`;
            currentVideoId = videoId;
            suggestions(videoId);
            updateVideoDataFromServer(videoId); 
            // suggestions(videoID);
            // views = viewsCount;
            // like = likeCount;
            // dislike = dislikeCount;
            // document.getElementById("likeCount").innerText = like;
            // document.getElementById("dislikeCount").innerText = dislike;
            // document.getElementById('videoTitle').textContent = title;
            // document.getElementById('videoDescription').textContent = description;
            // document.getElementById('channelName').textContent = channelName;
         
            // // document.getElementById("viewsCount").innerText = `Views: ${views}`;
            // console.log(videoId);
            // console.log(viewsCount);
            // console.log(likeCount);
            // console.log(dislikeCount);
            // likeButton.disabled=false;
            // dislikeButton.disabled=false;
            // updateViewsCount(views);
            // resetLikeDislike();
        }

        function updateViewsCount(view) {
            viewsCount += 1;
            document.getElementById("viewsCount").innerText = `Views: ${view+1}`;
            // const viewsCountSpan = document.getElementById('viewsCount');
            // viewsCountSpan.textContent = `Views: ${viewsCount}`;
            updateVideoData(videoId, '1');
        }

        function likeVideo(videoId, like) {
            if (!liked && !disliked) {
                liked = true;
                likeCount += 1;
                console.log(parseInt(like)+1);
                document.getElementById("likeCount").innerText = parseInt(like)+1;
                // updateLikeDislikeUI();
                // const likeButton = document.getElementById('likeButton');
                likeButton.disabled = true;
                dislikeButton.disabled = true;
                updateVideoData(videoId, 'like');
            }
        }

        function dislikeVideo(videoId, dislike) {
            if (!liked && !disliked) {
                disliked = true;
                dislikeCount += 1;
                document.getElementById("dislikeCount").innerText = dislike+1;
                // updateLikeDislikeUI();
                // const dislikeButton = document.getElementById('dislikeButton');
                dislikeButton.disabled = true;
                likeButton.disabled = true;
                updateVideoData(videoId, 'dislike');
            }
        }

        // function updateLikeDislikeUI() {
        //     const likeCountSpan = document.getElementById('likeCount');
        //     const dislikeCountSpan = document.getElementById('dislikeCount');
        //     likeCountSpan.textContent = likeCount;
        //     dislikeCountSpan.textContent = dislikeCount;
        // }

        // function resetLikeDislike() {
        //     liked = false;
        //     disliked = false;
        //     const likeButton = document.getElementById('likeButton');
        //     const dislikeButton = document.getElementById('dislikeButton');
        //     likeButton.textContent = 'Like';
        //     dislikeButton.textContent = 'Dislike';
        //     likeButton.disabled = false;
        //     dislikeButton.disabled = false;
        // }
        function updateVideoData(videoId, action) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            // console.log(`Updating video data for video ID ${videoId}...`);
            console.log(videoId)
            fetch("/update/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
            },
            body: `video_id=${encodeURIComponent(videoId)}&action=${encodeURIComponent(action)}`,
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Video data updated successfully.');
                } else {
                    console.error(`Error updating video data: ${data.error}`);
                }
            })
            .catch(error => console.error('Error:', error));
        }

    function updateVideoDataFromServer(videoId) {
        console.log(videoId);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/get_video_data/${encodeURIComponent(videoId)}/`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        })
        .then(response => response.json())
        .then(data => {
        if (data.success) {
            // Update your JSON with the new data
            const videoData = data.videoData; // Modify this based on your actual response structure
            console.log('Video data fetched successfully:', videoData);
            // Update your JSON here using the fetched data
            const statistics = videoData.videoInfo.statistics;
            const snippet = videoData.videoInfo.snippet;

            views = statistics.viewCount;
            like = statistics.likeCount;
            dislike = statistics.dislikeCount;
            title = snippet.title;
            description = snippet.description;
            channelName = snippet.channelTitle;

            console.log(views);
            console.log(like);
            console.log(dislike);
            console.log(title);
            console.log(description);
            console.log(channelName);

            document.getElementById("likeCount").innerText = like;
            document.getElementById("dislikeCount").innerText = dislike;
            document.getElementById('videoTitle').textContent = title;
            document.getElementById('videoDescription').textContent = description;
            document.getElementById('channelName').textContent = channelName;

            console.log(videoId);
            console.log(viewsCount);
            console.log(likeCount);
            console.log(dislikeCount);
            likeButton.disabled = false;
            dislikeButton.disabled = false;
            updateViewsCount(views);
        } else {
            console.error(`Error fetching video data: ${data.error}`);
        }
        })
        .catch(error => console.error('Error:', error));
        }

    function suggestions(videoID) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/suggestions/${encodeURIComponent(videoID)}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
        })
        .then(response => response.json())
        .then(data => {
            const searchResultsDiv = document.getElementById('searchResults');
            searchResultsDiv.innerHTML = ''; // Clear existing search results

            if (data.suggestions.length === 0) {
                const noSuggestions = document.createElement('div');
                noSuggestions.textContent = 'No suggestions available';
                searchResultsDiv.appendChild(noSuggestions);
            } else {
        
                data.suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    // suggestionItem.textContent = suggestion.videoInfo.snippet.title; // Adjust based on your data structure
                    const suggestDiv = document.createElement('div');
                    const titleDiv = document.createElement('div');
                    const viewsDiv = document.createElement('div');

                    suggestDiv.textContent = "Suggestions"
                    titleDiv.textContent = suggestion.videoInfo.snippet.title;
                    viewsDiv.textContent = `Views: ${suggestion.videoInfo.statistics.viewCount}`;

                    suggestionItem.classList.add('suggestion-box'); 
                    suggestionItem.addEventListener('click', () => {

                        playVideo(suggestion.videoInfo.id, suggestion.videoInfo.statistics.viewCount, suggestion.videoInfo.statistics.likeCount, 
                        suggestion.videoInfo.statistics.dislikeCount, suggestion.videoInfo.snippet.title, 
                        suggestion.videoInfo.snippet.description, suggestion.videoInfo.snippet.channelTitle);

                        document.getElementById('videoInfo').style.display = 'block';
                        document.getElementById('videoDetails').style.display = 'block';
                        // document.getElementById('channelBox').style.display = 'block';
                    });
                    suggestionItem.appendChild(suggestDiv);
                    suggestionItem.appendChild(titleDiv);
                    suggestionItem.appendChild(viewsDiv);
                    searchResultsDiv.appendChild(suggestionItem);
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }

    let favorited = false;

    function favoriteVideo(videoId) {
        const favoriteButton = document.getElementById('favoriteButton');
        const favoriteIcon = document.getElementById('favoriteIcon');

        if (!favorited) {
            favorited = true;
            favoriteIcon.style.color = 'red'; // Change heart color to red
            // favoriteIcon.style.border = '1px solid red'; // Change border color to red
            // Perform actions when favoriting a video (e.g., save to favorites list, update server, etc.)
            updateFavoriteStatus(videoId, true);
        } else {
            favorited = false;
            favoriteIcon.style.color = 'black'; // Change heart color to black
            // favoriteIcon.style.border = '1px solid black'; // Change border color to black
            // Perform actions when unfavoriting a video (e.g., remove from favorites list, update server, etc.)
            updateFavoriteStatus(videoId, false);
        }
    }

    function updateFavoriteStatus(videoId, isFavorite) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const action = isFavorite ? 'add' : 'remove';

        fetch(`/favorite_video/${encodeURIComponent(videoId)}/${action}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Video ${action}ed successfully.`);
            } else {
                console.error(`Error ${action}ing video: ${data.error}`);
            }
        })
        .catch(error => console.error('Error:', error));
    }
    </script>
</body>
</html>